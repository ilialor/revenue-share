# Архитектура библиотеки расчета выплат (RevShare.js)

## Общая структура проекта
```
/revenue-share-lib/
├── src/                          # Исходный код библиотеки
│   ├── core/                     # Ядро библиотеки
│   │   ├── RevenueSharing.js     # Основной класс
│   │   ├── SchemeValidator.js    # Валидатор схем
│   │   └── PayoutCalculator.js   # Калькулятор выплат
│   ├── schemes/                  # Предустановленные схемы
│   │   ├── index.js              # Экспорт всех схем
│   │   ├── BasicSchemes.js       # Базовые схемы
│   │   ├── AdvancedSchemes.js    # Продвинутые схемы
│   │   └── BuyToEarnSchemes.js   # Buy-to-Earn схемы
│   ├── utils/                    # Вспомогательные утилиты
│   │   ├── index.js              # Экспорт всех утилит
│   │   ├── ValidationUtils.js    # Утилиты валидации
│   │   └── MathUtils.js          # Математические утилиты
│   └── index.js                  # Главный экспортный файл
├── dist/                         # Скомпилированная библиотека
│   ├── revenue-share.js          # UMD версия
│   ├── revenue-share.min.js      # Минифицированная UMD версия
│   ├── revenue-share.esm.js      # ES модуль
│   └── revenue-share.cjs.js      # CommonJS модуль
├── tests/                        # Тесты
│   ├── unit/                     # Модульные тесты
│   │   ├── core/                 # Тесты ядра
│   │   ├── schemes/              # Тесты схем
│   │   └── utils/                # Тесты утилит
│   ├── integration/              # Интеграционные тесты
│   └── fixtures/                 # Тестовые данные
├── examples/                     # Примеры использования
│   ├── node/                     # Примеры для Node.js
│   ├── browser/                  # Примеры для браузера
│   └── complex-scenarios/        # Сложные сценарии
├── docs/                         # Документация
│   ├── api/                      # API документация
│   ├── examples/                 # Примеры с пояснениями
│   ├── Architecture.md           # Архитектура библиотеки
│   ├── BuyToEarn.md              # Документация по Buy-to-Earn модели
│   └── guides/                   # Руководства
├── .github/                      # GitHub конфигурации
│   └── workflows/                # CI/CD конфигурации
├── .eslintrc.js                  # ESLint конфигурация
├── .prettierrc                   # Prettier конфигурация
├── jest.config.js                # Jest конфигурация
├── rollup.config.js              # Rollup конфигурация
├── babel.config.js               # Babel конфигурация
├── tsconfig.json                 # TypeScript конфигурация
├── package.json                  # NPM конфигурация
├── README.md                     # Главный README файл
└── LICENSE                       # Лицензия
```

## Архитектурные принципы

### 1. Модульность
Библиотека разделена на независимые модули с четкими границами ответственности:
- **Core** - основные классы для работы с выплатами
- **Schemes** - предопределенные схемы разделения доходов
- **Utils** - вспомогательные функции

### 2. Расширяемость
- Возможность создания пользовательских схем
- Плагинная система для расширения функциональности
- Поддержка middleware для модификации процесса расчета

### 3. Типизация
- Полная поддержка TypeScript
- Строгая валидация входных данных
- Четкие интерфейсы для всех компонентов

### 4. Производительность
- Мемоизация расчетов для повторяющихся операций
- Оптимизация для работы с большим количеством продаж
- Асинхронные API для тяжелых расчетов

### 5. Поддержка различных сред
- Работа в браузере и Node.js
- Поддержка различных форматов модулей (UMD, ESM, CommonJS)
- Минимальные зависимости

## Основные компоненты

### RevenueSharing
Основной класс библиотеки, предоставляющий API для:
- Создания инстанса с параметрами продукта и схемы
- Добавления продаж
- Расчета выплат
- Получения статистики и отчетов

### SchemeValidator
Компонент для проверки валидности схем разделения доходов:
- Проверка структуры схемы
- Валидация процентных соотношений
- Предупреждения о потенциальных проблемах

### PayoutCalculator
Отдельный компонент для вычислений:
- Гибкие алгоритмы расчета
- Поддержка различных типов правил
- Оптимизация для больших объемов данных

## Интерфейс API

### Стандартная модель

```javascript
// Создание инстанса
const revShare = new RevenueSharing({
  productName: 'My Product',
  unitPrice: 100,
  scheme: myScheme
});

// Добавление продаж
revShare.addSale({ buyer: 'buyer1', timestamp: Date.now() });
revShare.addSales([...массив продаж...]);

// Расчет выплат
const payouts = revShare.calculatePayouts();

// Дополнительные методы
revShare.getSalesStats();
revShare.validateScheme();
revShare.exportData();
```

### Buy-to-Earn модель

```javascript
// Создание Buy-to-Earn инстанса
const buyToEarn = new RevenueSharing({
  productName: 'My Product',
  unitPrice: 500,
  useBuyToEarnModel: true,
  initialInvestment: 300000,
  creatorShare: 10,
  platformShare: 10,
  promotionShare: 10,
  paybackRatio: 2,
  nonPaybackPoolSharePercent: 60
});

// Или с использованием фабричного метода
const buyToEarn = RevShare.createBuyToEarn({
  productName: 'My Product',
  unitPrice: 500,
  initialInvestment: 300000
});

// Добавление продаж
buyToEarn.addSale({ buyer: 'buyer1', timestamp: Date.now() });

// Расчет выплат для конкретного токена
const payouts = buyToEarn.calculatePayouts({
  specificTokenNumber: 10
});

// Оценка окупаемости токена
const estimate = buyToEarn.estimateTokenPayback(100);
```

## Рабочий процесс расчета выплат

### Стандартная модель

1. **Инициализация:**
   - Создание инстанса с настройками
   - Валидация схемы

2. **Сбор данных:**
   - Добавление информации о продажах
   - Возможность массового импорта данных

3. **Расчет:**
   - Предварительная обработка данных
   - Применение правил схемы
   - Вычисление долей для каждой стороны

4. **Результаты:**
   - Структурированные данные о выплатах
   - Возможность экспорта в различные форматы

### Buy-to-Earn модель

1. **Инициализация:**
   - Создание инстанса с параметрами Buy-to-Earn модели

2. **Сбор данных:**
   - Добавление информации о продажах

3. **Расчет:**
   - Определение инвестиционной фазы и количества предоплатных токенов
   - Применение двух-пуловой модели распределения
   - Отслеживание окупаемости каждого токена

4. **Результаты:**
   - Накопленные доходы для всех участников
   - Статистика по окупаемости токенов
   - Прогнозы точек окупаемости для разных токенов

## Типы поддерживаемых схем

### 1. Базовые схемы
- Фиксированные проценты для сторон
- Распределение остатка

### 2. Схемы с группами покупателей
- Первые N покупателей
- Последние M покупателей
- Случайные группы покупателей

### 3. Продвинутые схемы
- Временные окна
- Объемные пороги (после X продаж)
- Комбинированные правила

### 4. Динамические схемы
- Изменение распределения в зависимости от времени
- Адаптивное распределение на основе объема продаж

### 5. Buy-to-Earn схемы
- Начальная инвестиционная фаза
- Приоритизация окупаемости через двух-пуловую модель
- Настраиваемые параметры распределения между участниками
- Различные стратегии окупаемости

## Модели распределения доходов

### Стандартные модели
Основаны на процентном распределении доходов от каждой продажи между участниками:
- Авторы/создатели
- Платформа
- Покупатели (возможно с группировкой)

### Buy-to-Earn модель
Двухфазная модель с инвестиционной предоплатой и системой окупаемости:
1. **Инвестиционная фаза**: Создатель получает 100% от начальных инвестиций
2. **Фаза регулярных продаж**: Доходы распределяются между:
   - Создателем (creatorShare%)
   - Платформой (platformShare%)
   - Продвижением (promotionShare%)
   - Покупателями (оставшиеся %)
   
Для распределения доли покупателей используется двух-пуловая система:
- Пул неокупившихся токенов: приоритетное распределение для токенов, не достигших окупаемости
- Общий пул: равномерное распределение между всеми токенами

## Особенности реализации

### Оптимизации производительности
- Мемоизация промежуточных результатов
- Эффективные структуры данных для хранения большого количества продаж
- Ленивые вычисления, где это возможно

### Работа с валютами
- Точные расчеты с учетом округления до центов
- Поддержка разных валют через конфигурацию

### Экспорт/импорт данных
- Сохранение состояния для долгосрочных расчетов
- Миграция данных между разными версиями
- Интеграция с другими системами

## Предустановленные схемы

### Стандартные схемы
- AUTHOR_CENTRIC: 80% автору, 20% платформе
- EQUAL_SPLIT: 50/50 между автором и платформой
- PLATFORM_FRIENDLY: 40% автору, 60% платформе
- COMMUNITY_EQUAL: 30% автору, 20% платформе, 50% покупателям
- EARLY_SUPPORTERS: 40% автору, 20% платформе, 30% первым 1000 покупателям, 10% всем покупателям
- и другие...

### Buy-to-Earn схемы
- STANDARD: Сбалансированная схема с равными долями между участниками
- CREATOR_FOCUSED: Повышенная доля создателя (20%)
- EARLY_PAYBACK: Ускоренная окупаемость ранних инвесторов (95% приоритет)
- EQUAL_DISTRIBUTION: Более равномерное распределение (25% приоритет)
- и другие...
